<!doctype html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مولّد الخطابات - جمعية معرفة</title>

  <!-- Local fonts (offline-friendly). Files live in assets/fonts/ -->
  <link rel="preload" as="font" type="font/ttf" href="assets/fonts/IBMPlexSansArabic-Regular.ttf" crossorigin>
  <link rel="preload" as="font" type="font/ttf" href="assets/fonts/IBMPlexSansArabic-Medium.ttf" crossorigin>
  <link rel="preload" as="font" type="font/ttf" href="assets/fonts/IBMPlexSansArabic-Bold.ttf" crossorigin>

  <link rel="icon" href="favicon.ico" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <link rel="stylesheet" href="css/app.css" />
  <link rel="stylesheet" href="css/date-picker.css" />
  <link rel="stylesheet" href="css/signature.css" />
</head>

<body data-mobile-view="form">
  <header class="topbar" aria-label="شريط الأدوات">
    <div class="topbar__title">
      <div class="badge">A4</div>
      <div>
        <div class="title">مولّد الخطابات</div>
        <div class="subtitle">جمعية معرفة</div>
      </div>
    </div>

    <div class="topbar__actions">
      <div class="mobileTabs" role="tablist" aria-label="التنقل">
        <button class="tab is-active" data-view="form" type="button">المدخلات</button>
        <button class="tab" data-view="preview" type="button">المعاينة</button>
      </div>

      <button class="btn btn--ghost" id="theme-toggle" type="button">
        <span class="theme-toggle-icon" aria-hidden="true"></span>
        <span class="theme-toggle-text"></span>
      </button>

      <button class="btn" id="btn-save" type="button" title="حفظ بيانات النموذج الحالي في المتصفح لاسترجاعها لاحقًا (بدون التوقيع)">حفظ المسودة</button>
      <button class="btn btn--ghost" id="btn-load" type="button" title="استرجاع آخر مسودة محفوظة من المتصفح">استرجاع المسودة</button>
      <button class="btn btn--primary" id="btn-export" type="button">تصدير PDF</button>
    </div>
  </header>

  <main class="layout">
    <!-- FORM -->
    <section class="panel form" aria-label="المدخلات">
      <div class="section">
        <div class="section__title">نوع الخطاب</div>

        <label class="field">
          <span class="field__label">نوع الخطاب</span>
          <select id="letterType" class="field__control">
            <option value="general" selected>خطاب عام</option>
            <option value="custody">طلب عهدة مالية</option>
            <option value="close_custody">طلب إغلاق عهدة مالية</option>
          </select>
        </label>

        <label class="field">
          <span class="field__label">التاريخ</span>
          <input id="date" type="hidden" />
          <input id="dateDisplay" class="field__control md3-text-field__input--date" placeholder=" " readonly />
          <span class="field__hint">اختر تاريخًا واحدًا وسيظهر هجري/ميلادي تلقائيًا</span>
        </label>
      </div>

      <div class="section" id="section-costcenter">
        <div class="section__title">مركز التكلفة</div>

        <div class="grid2">
          <label class="field">
            <span class="field__label">مركز التكلفة (Cost Center)</span>
            <select id="costCenter" class="field__control"></select>
            <span class="field__hint">اختيار مركز التكلفة يغني عن الأكواد التفصيلية واسم المشروع</span>
          </label>

          <label class="field">
            <span class="field__label">اسم البرنامج</span>
            <input id="programNameDisplay" class="field__control" readonly />
            <span class="field__hint">يُحدد تلقائيًا من مركز التكلفة</span>
          </label>
        </div>
      </div>

      <div class="section">
        <div class="section__title">بيانات مقدم الطلب</div>

        <div class="grid2">
          <label class="field">
            <span class="field__label">اسم مقدم الطلب</span>
            <input id="applicantName" class="field__control" placeholder="مثال: م. علي عبدالله العليان" />
          </label>

          <label class="field">
            <span class="field__label">المسمى الوظيفي</span>
            <input id="jobTitle" class="field__control" placeholder="مثال: مدير إدارة البرامج والمشاريع" />
          </label>
        </div>

        <label class="field">
          <span class="field__label">الموضوع</span>
          <input id="subject" class="field__control" placeholder="يُملأ تلقائيًا ويمكن تعديله" />
        </label>

        <label class="field">
          <span class="field__label">تفاصيل الطلب</span>
          <textarea id="details" class="field__control field__control--textarea" rows="7" placeholder="اكتب التفاصيل هنا..."></textarea>
        </label>
      </div>

      <div class="section" id="section-extra">
        <div class="section__title">بيانات إضافية</div>

        <!-- custody -->
        <div id="extra-custody" class="extra">
          <label class="field">
            <span class="field__label">مبلغ العهدة المطلوب (ريال)</span>
            <input id="custodyAmount" class="field__control" inputmode="decimal" placeholder="5000" />
            <span class="field__hint">الحد الأعلى المعتمد 5,000 ريال سعودي</span>
          </label>
        </div>

        <!-- close custody -->
        <div id="extra-close" class="extra">
          <div class="grid2">
            <label class="field">
              <span class="field__label">المبلغ المستخدم (ريال)</span>
              <input id="usedAmount" class="field__control" inputmode="decimal" placeholder="0" />
            </label>

            <label class="field">
              <span class="field__label">المبلغ المتبقي (ريال)</span>
              <input id="remainingAmount" class="field__control" inputmode="decimal" placeholder="0" />
            </label>
          </div>

          <label class="field">
            <span class="field__label">عدد المشفوعات</span>
            <input id="attachments" class="field__control" inputmode="numeric" placeholder="0" />
          </label>
        </div>

        <!-- general -->
        <div id="extra-general" class="extra">
          <label class="field">
            <span class="field__label">عدد المشفوعات (اختياري)</span>
            <input id="attachmentsGeneral" class="field__control" inputmode="numeric" placeholder="0" />
          </label>
        </div>
      </div>

      <div class="section">
        <div class="section__title">التوقيع</div>

        <div class="grid2">
          <label class="field">
            <span class="field__label">طريقة التوقيع</span>
            <select id="signatureMode" class="field__control">
              <option value="canvas">توقيع مباشر (Canvas)</option>
              <option value="upload">رفع صورة التوقيع</option>
            </select>
          </label>

          <label class="field section-animated is-hidden" id="signatureUploadField">
            <span class="field__label">رفع صورة التوقيع</span>
            <input id="signatureFile" type="file" accept="image/*" class="field__control" />
          </label>
        </div>

        <div id="signatureCanvasWrap" class="signature-canvas-container">
          <canvas id="signatureCanvas" height="140" tabindex="0" aria-label="لوحة التوقيع"></canvas>

          <div class="signature-toolbar">
            <div class="signature-toolbar-left">
              <div class="pen-controls">
                <div class="pen-control-group pen-size-control">
                  <span class="pen-control-label">سُمك القلم</span>
                  <input id="penSize" type="range" min="1" max="8" step="0.5" value="2" />
                  <span id="penSizeValue" class="pen-size-value">2px</span>
                </div>

                <div class="pen-control-group pen-color-control">
                  <span class="pen-control-label">اللون</span>
                  <input id="penColor" type="color" value="#1d4ed8" />
                </div>
              </div>

              <button type="button" class="md3-icon-button-sm icon-undo" id="undoSignature" title="تراجع"></button>
              <button type="button" class="md3-icon-button-sm icon-redo" id="redoSignature" title="إعادة"></button>
            </div>

            <div class="signature-toolbar-right signature-actions">
              <button class="btn btn--ghost" id="clearSignature" type="button">مسح</button>
            </div>
          </div>

          <div class="signature-helper-text">
            <span class="sig-helper-icon" aria-hidden="true">؟</span>
            <span>ارسم التوقيع داخل المربع، وسيظهر في المعاينة مباشرة.</span>
          </div>

          <div id="aria-live-region" class="sr-only" aria-live="polite"></div>
        </div>
      </div>

      <div class="section small-note">
        <div class="section__title">ملاحظة</div>
        <div class="muted">
          للتأكد من عدم ظهور أجزاء من الواجهة في PDF: استخدم زر <b>تصدير PDF</b> داخل الموقع.
          كما يدعم الموقع Ctrl/⌘ + P بدون ظهور الواجهة (بفضل إعدادات الطباعة).
        </div>
        <div class="muted" style="margin-top:6px;">
          <b>حفظ المسودة</b>: يحفظ بيانات النموذج في المتصفح حتى لو أغلقت الصفحة (بدون التوقيع).
          <b>استرجاع المسودة</b>: يعيد تعبئة النموذج من آخر حفظ. يرجى إعادة التوقيع بعد الاسترجاع.
        </div>
      </div>
    </section>

    <!-- PREVIEW -->
    <section class="panel preview" aria-label="المعاينة">
      <div class="preview__header">
        <div>
          <div class="preview__title">المعاينة</div>
          <div class="preview__meta muted">تحديث مباشر • A4</div>
        </div>

        <div class="zoom-bar" aria-label="أدوات المعاينة">
          <button class="zoom-bar__btn" id="btn-zoomout" type="button" title="تصغير" aria-label="تصغير">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
          <button class="zoom-bar__btn" id="btn-zoomfit" type="button" title="ملاءمة العرض" aria-label="ملاءمة">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>
          </button>
          <button class="zoom-bar__btn" id="btn-zoomin" type="button" title="تكبير" aria-label="تكبير">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
      </div>

      <div id="printRoot" class="printRoot" aria-label="صفحات الخطاب"></div>

      <div id="mobilePreview" class="mobilePreview" aria-label="معاينة الجوال">
        <div class="viewerViewport" id="viewerViewport" aria-label="عرض الصفحة">
          <div class="viewerStage" id="viewerStage">
            <img id="viewerImg" alt="معاينة الصفحة"/>
          </div>
          <div id="viewerLoading" class="viewerLoading" aria-live="polite" aria-label="جاري تحديث المعاينة">
            <div class="spinner"></div>
            <div>جاري تحديث المعاينة…</div>
          </div>
        </div>

        <div class="viewerPager" aria-label="التنقل بين الصفحات">
          <button class="btn btn--ghost" id="viewerPrev" type="button">السابق</button>
          <div id="viewerIndicator" class="viewerIndicator">1 / 1</div>
          <button class="btn btn--ghost" id="viewerNext" type="button">التالي</button>
        </div>

        <div class="viewerHint muted">
          اسحب يمينًا/يسارًا للتنقل بين الصفحات • قرّب/بعّد بإصبعين للتكبير
        </div>
      </div>


      <div class="preview__footer muted">
        على الجوال: استخدم زر <b>المعاينة</b> بالأعلى ثم <b>تصدير PDF</b>.
      </div>
    </section>
  </main>

  <!-- Bottom navigation (mobile) -->
  <nav class="bottomTabs" role="tablist" aria-label="التنقل">
    <button class="tab is-active" data-view="form" type="button">المدخلات</button>
    <button class="tab" data-view="preview" type="button">المعاينة</button>
  </nav>

  <!-- PDF export libs (for iOS parity). Used by js/print.js. -->
  <!-- PDF export libs are loaded on-demand (see js/print.js) to improve reliability on iOS -->


  <!-- Toast notification container -->
  <div id="toastContainer" class="toast-container" aria-live="polite"></div>

  <script src="js/hijri-converter.js"></script>
  <script src="js/date-picker.js"></script>
  <script src="js/signature-enhanced.js"></script>
  <script src="js/theme.js"></script>

  <script src="js/utils.js"></script>
  <script src="js/templates.js"></script>
  <script src="js/pagination.js"></script>
  <script src="js/canvas-renderer.js"></script>
  <script src="js/print.js"></script>
  <script src="js/mobile-preview.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
