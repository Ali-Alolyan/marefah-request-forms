<!doctype html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#1e5aa8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; connect-src 'self' https://rlftalctuaybztrgegnb.supabase.co https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; object-src 'none'; worker-src 'self' blob:" />
  <meta name="description" content="مولّد خطابات رسمية لجمعية معرفة — إنشاء خطابات A4 بالتاريخ الهجري والميلادي والتوقيع الرقمي وتصدير PDF" />
  <title>مولّد الخطابات - جمعية معرفة</title>

  <!-- Local fonts (offline-friendly). Files live in assets/fonts/ -->
  <link rel="preload" as="font" type="font/woff2" href="assets/fonts/saudi_riyal.woff2" crossorigin>
  <link rel="preload" as="font" type="font/ttf" href="assets/fonts/IBMPlexSansArabic-Regular.ttf" crossorigin>
  <link rel="preload" as="font" type="font/ttf" href="assets/fonts/IBMPlexSansArabic-Medium.ttf" crossorigin>
  <link rel="preload" as="font" type="font/ttf" href="assets/fonts/IBMPlexSansArabic-Bold.ttf" crossorigin>

  <link rel="icon" href="favicon.ico" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <link rel="stylesheet" href="css/app.css" />
  <link rel="stylesheet" href="css/date-picker.css" />
  <link rel="stylesheet" href="css/signature.css" />
</head>

<body data-mobile-view="form">
  <!-- Login overlay -->
  <div id="loginOverlay" class="login-overlay is-active" role="dialog" aria-modal="true" aria-label="تسجيل الدخول">
    <div class="login-card">
      <div class="login-card__header">تسجيل الدخول</div>
      <p class="login-card__sub">أدخل كود الحساب الخاص بك للمتابعة</p>
      <form id="loginForm" autocomplete="off">
        <label class="field">
          <span class="field__label">كود الحساب</span>
          <input id="loginCode" class="field__control" type="text" inputmode="numeric" maxlength="9" dir="ltr" placeholder="000000000" autocomplete="off" />
        </label>
        <div id="loginError" class="login-error" style="display:none"></div>
        <button id="loginSubmit" class="btn btn--primary login-btn" type="submit">تسجيل الدخول</button>
      </form>
    </div>
  </div>

  <header class="topbar" aria-label="شريط الأدوات">
    <div class="topbar__title">
      <div class="badge">A4</div>
      <div>
        <div class="title">مولّد الخطابات</div>
        <div class="subtitle">جمعية معرفة</div>
      </div>
    </div>

    <div class="topbar__actions">
      <div class="mobileTabs" role="tablist" aria-label="التنقل">
        <button class="tab is-active" data-view="form" type="button" role="tab" aria-selected="true">المدخلات</button>
        <button class="tab" data-view="preview" type="button" role="tab" aria-selected="false">المعاينة</button>
      </div>

      <button class="btn btn--ghost" id="theme-toggle" type="button">
        <span class="theme-toggle-icon" aria-hidden="true"></span>
        <span class="theme-toggle-text"></span>
      </button>

      <button class="btn" id="btn-save" type="button" title="حفظ بيانات النموذج الحالي في المتصفح لاسترجاعها لاحقًا (بدون التوقيع)">حفظ المسودة</button>
      <button class="btn btn--ghost" id="btn-load" type="button" title="استرجاع آخر مسودة محفوظة من المتصفح">استرجاع المسودة</button>
      <button class="btn btn--primary" id="btn-export" type="button">تصدير PDF</button>
    </div>
  </header>

  <main class="layout">
    <!-- FORM -->
    <section class="panel form" aria-label="المدخلات">
      <div class="section">
        <div class="section__title">نوع الخطاب</div>

        <label class="field">
          <span class="field__label">نوع الخطاب <span class="required-mark">*</span></span>
          <select id="letterType" class="field__control">
            <option value="general" selected>خطاب مخصص</option>
            <option value="general_financial">طلب مالي عام</option>
            <option value="custody">طلب عهدة مالية</option>
            <option value="close_custody">طلب إغلاق عهدة مالية</option>
          </select>
        </label>

        <label class="field">
          <span class="field__label">التاريخ <span class="required-mark">*</span></span>
          <input id="date" type="hidden" />
          <input id="dateDisplay" class="field__control md3-text-field__input--date" placeholder=" " readonly />
          <span class="field__hint">اختر تاريخًا واحدًا وسيظهر هجري/ميلادي تلقائيًا</span>
        </label>
      </div>

      <div class="section" id="section-costcenter">
        <div class="section__title">المشروع ومركز التكلفة</div>

        <label class="agreement-check financial-cost-toggle section-animated is-hidden" id="financialCostCenterToggleWrap">
          <input type="checkbox" id="financialIncludeCostCenter" />
          <span>إرفاق مركز التكلفة في الخطاب (اختياري)</span>
          <span class="field__hint">يمكنك تركه غير مفعّل لإرسال الطلب بدون مركز تكلفة.</span>
        </label>

        <div id="projectCostFieldsWrap" class="section-animated">
          <label class="field">
            <span class="field__label">اسم المشروع</span>
            <select id="projectName" class="field__control"></select>
            <span class="field__hint">يُحدد تلقائيًا من المشاريع المسندة إليك</span>
          </label>

          <div class="grid2">
            <label class="field">
              <span class="field__label">مركز التكلفة (Cost Center)</span>
              <input id="costCenter" class="field__control" readonly />
            </label>

            <label class="field">
              <span class="field__label">اسم البرنامج</span>
              <input id="programNameDisplay" class="field__control" readonly />
            </label>
          </div>
        </div>

        <div id="no-projects-hint" class="field__hint" style="display:none;color:var(--md-sys-color-error,#b3261e)">
          لا توجد مشاريع مسندة إليك. يمكنك إنشاء خطاب مخصص أو طلب مالي عام بدون مركز تكلفة.
        </div>
      </div>

      <div class="section">
        <div class="section__title section__title--flex">بيانات مقدم الطلب <button id="btn-logout" class="btn btn--ghost btn--logout" type="button" style="display:none">تسجيل خروج</button></div>

        <div class="grid2">
          <label class="field">
            <span class="field__label">المسمى الوظيفي <span class="required-mark">*</span></span>
            <input id="jobTitle" class="field__control" placeholder="مثال: مدير إدارة البرامج والمشاريع" />
          </label>

          <label class="field">
            <span class="field__label">اسم مقدم الطلب <span class="required-mark">*</span></span>
            <input id="applicantName" class="field__control" placeholder="مثال: م. علي عبدالله العليان" />
          </label>
        </div>

        <label class="field">
          <span class="field__label">الموضوع <span class="required-mark">*</span></span>
          <input id="subject" class="field__control" placeholder="أدخل موضوع الخطاب" />
        </label>

        <label class="field">
          <span class="field__label">تفاصيل الطلب</span>
          <textarea id="details" class="field__control field__control--textarea" rows="7" placeholder="اكتب التفاصيل هنا..."></textarea>
        </label>
      </div>

      <div class="section" id="section-extra">
        <div class="section__title">بيانات إضافية</div>

        <!-- custody -->
        <div id="extra-custody" class="extra">
          <label class="field">
            <span class="field__label">مبلغ العهدة المطلوب (ريال)</span>
            <input id="custodyAmount" class="field__control" inputmode="decimal" placeholder="5000" />
            <span class="field__hint">أدخل مبلغ العهدة بالريال السعودي</span>
          </label>
        </div>

        <!-- general financial -->
        <div id="extra-financial" class="extra">
          <label class="field">
            <span class="field__label">المبلغ المطلوب (ريال) <span class="required-mark">*</span></span>
            <input id="financialAmount" class="field__control" inputmode="decimal" placeholder="5000" />
            <span class="field__hint">حقل إلزامي. أدخل المبلغ المطلوب بالريال السعودي (مثال: 12500).</span>
          </label>
        </div>

        <!-- close custody -->
        <div id="extra-close" class="extra">
          <div class="grid2">
            <label class="field">
              <span class="field__label">المبلغ المستخدم (ريال)</span>
              <input id="usedAmount" class="field__control" inputmode="decimal" placeholder="0" />
            </label>

            <label class="field">
              <span class="field__label">المبلغ المتبقي (ريال)</span>
              <input id="remainingAmount" class="field__control" inputmode="decimal" placeholder="0" />
            </label>
          </div>

          <label class="field">
            <span class="field__label">عدد المشفوعات</span>
            <input id="attachments" class="field__control" type="number" step="1" min="0" inputmode="numeric" placeholder="0" readonly />
            <span class="field__hint">يُحدث تلقائيًا بناءً على الملفات المرفقة</span>
          </label>

          <div class="attachment-upload" id="attachment-upload-close">
            <span class="field__label">إرفاق المشفوعات (صور/PDF)</span>
            <p class="attachment-explainer">المشفوعات هي المستندات والوثائق المرفقة مع الخطاب، مثل: الفواتير، الإيصالات، صور المستندات، أو أي ملفات داعمة للطلب.</p>
            <div class="file-drop-zone" id="file-drop-zone-close" tabindex="0" role="button" aria-label="منطقة رفع الملفات">
              <div class="file-drop-zone__content">
                <div class="file-drop-zone__icon" aria-hidden="true">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                </div>
                <div class="file-drop-zone__text">اسحب الملفات هنا أو</div>
                <button type="button" class="btn btn--ghost file-drop-zone__btn">اختر ملفات</button>
                <div class="file-drop-zone__hint">PNG, JPG, WebP, PDF (حد أقصى 10 ميجا لكل ملف)</div>
              </div>
              <input type="file" class="file-drop-zone__input" id="file-input-close" multiple accept="image/png,image/jpeg,image/webp,application/pdf" />
            </div>
            <div class="attachment-previews" id="attachment-previews-close"></div>
          </div>
        </div>

        <!-- general -->
        <div id="extra-general" class="extra">
          <label class="field">
            <span class="field__label">عدد المشفوعات (اختياري)</span>
            <input id="attachmentsGeneral" class="field__control" type="number" step="1" min="0" inputmode="numeric" placeholder="0" readonly />
            <span class="field__hint">يُحدث تلقائيًا بناءً على الملفات المرفقة</span>
          </label>

          <div class="attachment-upload" id="attachment-upload-general">
            <span class="field__label">إرفاق المشفوعات (صور/PDF)</span>
            <p class="attachment-explainer">المشفوعات هي المستندات والوثائق المرفقة مع الخطاب، مثل: الفواتير، الإيصالات، صور المستندات، أو أي ملفات داعمة للطلب.</p>
            <div class="file-drop-zone" id="file-drop-zone-general" tabindex="0" role="button" aria-label="منطقة رفع الملفات">
              <div class="file-drop-zone__content">
                <div class="file-drop-zone__icon" aria-hidden="true">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                </div>
                <div class="file-drop-zone__text">اسحب الملفات هنا أو</div>
                <button type="button" class="btn btn--ghost file-drop-zone__btn">اختر ملفات</button>
                <div class="file-drop-zone__hint">PNG, JPG, WebP, PDF (حد أقصى 10 ميجا لكل ملف)</div>
              </div>
              <input type="file" class="file-drop-zone__input" id="file-input-general" multiple accept="image/png,image/jpeg,image/webp,application/pdf" />
            </div>
            <div class="attachment-previews" id="attachment-previews-general"></div>
          </div>
        </div>
      </div>

      <div class="section section-animated is-hidden" id="section-agreement">
        <div class="section__title">الإقرار والتعهد</div>
        <label class="agreement-check">
          <input type="checkbox" id="agreeTerms" />
          <span>أقر بالاطلاع والالتزام بالضوابط والإجراءات المالية التالية:</span>
        </label>
        <ol class="agreement-list" dir="rtl">
          <li><b>نظامية الفواتير:</b> يجب أن تكون جميع الفواتير رسمية (إلكترونية).</li>
          <li><b>بيانات الجهة:</b> ضرورة إدراج اسم الجمعية والرقم الضريبي بشكل واضح على الفواتير.</li>
          <li><b>المدة الزمنية:</b> الالتزام بإقفال العهدة خلال مدة لا تتجاوز 60 يوماً من تاريخ استلامها.</li>
          <li><b>نموذج الإقفال:</b> تُفرغ بيانات الفواتير في "نموذج إقفال العهدة" المعتمد، والذي سيتم تزويدكم به من قبل الإدارة المالية.</li>
          <li><b>مطابقة المبلغ:</b> يجب أن يكون إجمالي مبلغ الإقفال مساوياً للمبلغ الذي تم تحويله للعهدة تماماً.</li>
          <li><b>التوثيق الضوئي:</b> يرجى تصوير الفواتير "الحرارية" (الورق الحساس) ضوئياً؛ لضمان عدم تلاشي البيانات مع مرور الوقت.</li>
        </ol>
      </div>

      <div class="section">
        <div class="section__title">التوقيع</div>
        <p class="signature-privacy-note">التوقيع لا يُحفظ في أي قاعدة بيانات، ويُستخدم فقط لإنشاء ملف PDF على جهازك.</p>

        <div class="grid2">
          <label class="field">
            <span class="field__label">طريقة التوقيع</span>
            <select id="signatureMode" class="field__control">
              <option value="canvas">توقيع مباشر (Canvas)</option>
              <option value="upload">رفع صورة التوقيع</option>
            </select>
          </label>

          <label class="field section-animated is-hidden" id="signatureUploadField">
            <span class="field__label">رفع صورة التوقيع</span>
            <input id="signatureFile" type="file" accept="image/*" class="field__control" />
          </label>
        </div>

        <div id="signatureCanvasWrap" class="signature-canvas-container">
          <canvas id="signatureCanvas" height="140" tabindex="0" aria-label="لوحة التوقيع" aria-describedby="signatureHelperText"></canvas>

          <div class="signature-toolbar">
            <div class="signature-toolbar-left">
              <div class="pen-controls">
                <div class="pen-control-group pen-size-control">
                  <span class="pen-control-label">سُمك القلم</span>
                  <input id="penSize" type="range" min="1" max="8" step="0.5" value="2" />
                  <span id="penSizeValue" class="pen-size-value">2px</span>
                </div>

                <div class="pen-control-group pen-color-control">
                  <span class="pen-control-label">اللون</span>
                  <input id="penColor" type="color" value="#1d4ed8" />
                </div>
              </div>

              <button type="button" class="md3-icon-button-sm icon-undo" id="undoSignature" title="تراجع"></button>
              <button type="button" class="md3-icon-button-sm icon-redo" id="redoSignature" title="إعادة"></button>
            </div>

            <div class="signature-toolbar-right signature-actions">
              <button class="btn btn--ghost" id="clearSignature" type="button">مسح</button>
            </div>
          </div>

          <div class="signature-helper-text">
            <span class="sig-helper-icon" aria-hidden="true">؟</span>
            <span id="signatureHelperText">ارسم التوقيع داخل المربع، وسيظهر في المعاينة مباشرة.</span>
          </div>

          <div id="aria-live-region" class="sr-only" aria-live="polite"></div>
        </div>
      </div>

      <div class="section small-note">
        <div class="section__title">ملاحظة</div>
        <div class="muted">
          للتأكد من عدم ظهور أجزاء من الواجهة في PDF: استخدم زر <b>تصدير PDF</b> داخل الموقع.
          كما يدعم الموقع Ctrl/⌘ + P بدون ظهور الواجهة (بفضل إعدادات الطباعة).
        </div>
        <div class="muted" style="margin-top:6px;">
          <b>حفظ المسودة</b>: يحفظ بيانات النموذج في المتصفح حتى لو أغلقت الصفحة (بدون التوقيع).
          <b>استرجاع المسودة</b>: يعيد تعبئة النموذج من آخر حفظ. يرجى إعادة التوقيع بعد الاسترجاع.
        </div>
      </div>
    </section>

    <!-- PREVIEW -->
    <section class="panel preview" aria-label="المعاينة">
      <div class="preview__header">
        <div>
          <div class="preview__title">المعاينة</div>
          <div class="preview__meta muted">تحديث مباشر • A4</div>
        </div>

        <div class="zoom-bar" aria-label="أدوات المعاينة">
          <button class="zoom-bar__btn" id="btn-zoomout" type="button" title="تصغير" aria-label="تصغير">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
          <button class="zoom-bar__btn" id="btn-zoomfit" type="button" title="ملاءمة العرض" aria-label="ملاءمة">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>
          </button>
          <button class="zoom-bar__btn" id="btn-zoomin" type="button" title="تكبير" aria-label="تكبير">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
      </div>

      <div id="printRoot" class="printRoot" aria-label="صفحات الخطاب"></div>

      <div id="mobilePreview" class="mobilePreview" aria-label="معاينة الجوال">
        <div class="viewerViewport" id="viewerViewport" aria-label="عرض الصفحة">
          <div class="viewerStage" id="viewerStage">
            <img id="viewerImg" alt="معاينة الصفحة"/>
          </div>
          <div id="viewerLoading" class="viewerLoading" aria-live="polite" aria-label="جاري تحديث المعاينة">
            <div class="spinner"></div>
            <div>جاري تحديث المعاينة…</div>
          </div>
        </div>

        <div class="viewerPager" aria-label="التنقل بين الصفحات">
          <button class="btn btn--ghost" id="viewerPrev" type="button">السابق</button>
          <div id="viewerIndicator" class="viewerIndicator">1 / 1</div>
          <button class="btn btn--ghost" id="viewerNext" type="button">التالي</button>
        </div>

        <div class="viewerHint muted">
          اسحب يمينًا/يسارًا للتنقل بين الصفحات • قرّب/بعّد بإصبعين للتكبير
        </div>
      </div>


      <div class="preview__footer muted">
        على الجوال: استخدم زر <b>المعاينة</b> في الشريط السفلي ثم <b>تصدير PDF</b>.
      </div>
    </section>
  </main>

  <!-- Bottom navigation (mobile) -->
  <nav class="bottomTabs" role="tablist" aria-label="التنقل">
    <button class="tab is-active" data-view="form" type="button" role="tab" aria-selected="true">المدخلات</button>
    <button class="tab" data-view="preview" type="button" role="tab" aria-selected="false">المعاينة</button>
    <button class="btn btn--ghost bottomTabs__action" id="btn-save-mobile" type="button" title="حفظ المسودة">حفظ</button>
    <button class="btn btn--ghost bottomTabs__action" id="btn-load-mobile" type="button" title="استرجاع المسودة">استرجاع</button>
  </nav>

  <!-- PDF export libs (for iOS parity). Used by js/print.js. -->
  <!-- PDF export libs are loaded on-demand (see js/print.js) to improve reliability on iOS -->


  <!-- Export progress overlay -->
  <div id="exportSpinner" class="export-spinner" style="display:none" role="status" aria-live="polite" aria-label="جاري تجهيز ملف PDF">
    <div class="export-spinner__card">
      <div class="spinner" aria-hidden="true"></div>
      <div>جاري تجهيز ملف PDF…</div>
    </div>
  </div>

  <!-- Toast notification container -->
  <div id="toastContainer" class="toast-container" aria-live="polite"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"
          integrity="sha384-YieCqqg9gQufX7+5HcFvCEg/n3KUEdl8/Jb+A6J0npf1mB740VayvwKjTrtCeUoy"
          crossorigin="anonymous"></script>
  <script src="js/auth.js"></script>

  <script src="js/hijri-converter.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/date-picker.js"></script>
  <script src="js/signature-enhanced.js"></script>
  <script src="js/theme.js"></script>

  <script src="js/templates.js"></script>
  <script src="js/pagination.js"></script>
  <script src="js/canvas-renderer.js"></script>
  <script src="js/pdf-loader.js"></script>
  <script src="js/print.js"></script>
  <script src="js/mobile-preview.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
