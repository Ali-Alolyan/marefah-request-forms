# مولّد الخطابات - جمعية معرفة

مولّد خطابات عربي خفيف (Static Web App) يدعم:
- **خطاب عام**
- **طلب مالي عام**
- **طلب عهدة**
- **طلب إغلاق عهدة**
- معاينة **A4** فورية مع كليشة الجمعية
- تصدير **PDF** (متوافق مع Safari/Chrome على Mac و iPhone)

> جميع الخطابات موجهة إلى: **سعادة المدير التنفيذي/ أ.د. محمد عبدالعزيز العواجي حفظه الله**

---

## تشغيل محلي

```bash
# من مجلد المشروع
python3 -m http.server 8080
# افتح http://localhost:8080/
```

---

## التطوير

### المتطلبات
- Node.js 20+
- npm

### تثبيت التبعيات
```bash
npm install
```

### الاختبارات
```bash
npm test              # تشغيل الاختبارات
npm run test:watch    # وضع المراقبة (يعيد التشغيل عند التعديل)
npm run test:ci       # تشغيل مع تقرير مفصّل (للـ CI)
```

الاختبارات تغطي الوحدات التالية:
- `utils.js` — تنسيق الأرقام، تحليل المبالغ، تواريخ ISO، تهريب HTML
- `hijri-converter.js` — تحويل التواريخ بين الهجري والميلادي
- `templates.js` — بناء محتوى الخطاب حسب النوع
- `auth.js` — تطبيع كود الحساب، بناء اسم المقدّم، تجزئة الجلسة
- `app.js` — دوال مساعدة لأنواع الخطابات والمرفقات
- `print.js` — بناء PDF من صور JPEG
- `canvas-renderer.js` — تحويل الوحدات (mm/px) ومعالجة النصوص

### فحص الكود (Linting)
```bash
npm run lint
```

يستخدم ESLint 9 (flat config) مع إعدادات مخصصة لبيئة المتصفح والمتغيرات العامة المشتركة بين الملفات.

---

## النشر (CI/CD)

النشر عبر GitHub Pages يتم تلقائياً عند الدفع إلى فرع `main` من خلال `.github/workflows/static.yml`.

خط الأنابيب يتكون من مرحلتين:
1. **test** — تثبيت التبعيات، فحص الكود، تشغيل الاختبارات
2. **deploy** — نشر إلى GitHub Pages (يعمل فقط إذا نجحت مرحلة الاختبار)

---

## تصدير PDF

- زر **تصدير PDF** يولّد ملف PDF مباشرة بدون Print/Popups (رندر Canvas + خط مضمّن)
- متوافق مع Safari/Chrome على Mac و iPhone
- التصدير لا يعتمد على إعدادات الطباعة
- تصدير الخطاب الأساسي لا يعتمد على مكتبات خارجية
- **مرفقات PDF** تستخدم `pdf.js` بتحميل محلي أولاً، وإذا لم تتوفر الملفات محلياً يتم استخدام CDN كخيار احتياطي
- على الجوال: إذا كانت الذاكرة منخفضة، قد يخفض التطبيق الدقة تلقائياً (300 → 240 DPI)

---

## الجوال (Responsive)

- على الشاشات الصغيرة (< 640px) يظهر شريط تبديل بالأسفل: **المدخلات** / **المعاينة**
- المعاينة تُصغّر تلقائياً لتناسب عرض الشاشة

---

## تخصيص مواضع حقول الهيدر

في `css/app.css` ستجد متغيرات (بوحدة mm) لحقول الهيدر:
- `--ov-hijri-top/left`
- `--ov-greg-top/left`
- `--ov-att-top/left`
- `--ov-date-shift-x` لتحريك التاريخين أفقياً (القيمة الافتراضية: `-5px`)

---

## استبدال الكليشة (Letterhead)

| الملف | الاستخدام | الأبعاد |
|-------|-----------|---------|
| `assets/letterhead.png` | معاينة خفيفة | - |
| `assets/letterhead-300.jpg` | تصدير PDF | 2482×3510 px (300 DPI) |
| `assets/letterhead-240.jpg` | جوال/احتياطي | - |
| `assets/letterhead-150.jpg` | معاينة منخفضة الدقة | - |

## الخط (Fonts)

الخط مضمّن محلياً داخل `assets/fonts/IBMPlexSansArabic-*.ttf` مع ملف الترخيص `assets/fonts/OFL.txt`.
